<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Encurtador de Links</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .linkItem { background: #e9f1fb; padding: 10px; border-radius: 5px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; }
    .linkItem button { margin-left: 10px; }
  </style>
</head>
<body>
  <div id="container">
    <h2>Encurtador de Links</h2>
    <input type="url" id="urlInput" placeholder="Cole sua URL aqui...">
    <button onclick="encurtar()">Encurtar (5 moedas)</button>

    <h3>Meus Links</h3>
    <div id="meusLinks"></div>

    <div id="shortResult"></div>
  </div>
<div id="meusLinks"></div>

    <script>
        async function listarLinks() {
            const res = await fetch("/api/short", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "list" }),
                credentials: "include"
            });

            const data = await res.json();
            const container = document.getElementById("meusLinks");
            container.innerHTML = "";

            if (Array.isArray(data.response)) {
                data.response.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "linkItem clickable-link";
                    div.dataset.shortId = item.id;
                    div.dataset.url = item.url;

                    div.innerHTML = `
                        <span><strong>/s/${item.id}</strong></span>
                        <button onclick="apagar('${item.id}')">Excluir</button>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // Evento de clique nos links encurtados
        document.getElementById("meusLinks").addEventListener("click", async function (e) {
            const el = e.target.closest(".clickable-link");
            if (!el) return;

            const shortId = el.dataset.shortId;
            const targetUrl = el.dataset.url;

            const result = await Swal.fire({
                title: "Link Encurtado",
                html: `
                    <div style="text-align: left">
                        <p><strong>Link curto:</strong> <a href="/s/${shortId}" target="_blank">/s/${shortId}</a></p>
                        <p><strong>Destino:</strong> <code>${targetUrl}</code></p>
                    </div>
                `,
                showConfirmButton: false,
                showDenyButton: true,
                denyButtonText: "Excluir",
                showCancelButton: true,
                cancelButtonText: "Fechar"
            });

            if (result.isDenied) {
                const confirm = await Swal.fire({
                    title: "Tem certeza?",
                    text: `Excluir o link /s/${shortId}?`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sim, excluir",
                    cancelButtonText: "Cancelar"
                });

                if (confirm.isConfirmed) {
                    await apagar(shortId);
                }
            }
        });

        // Função para apagar link
        async function apagar(id) {
            const res = await fetch("/api/short", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ action: "delete", id: id })
            });

            const data = await res.json();
            await Swal.fire("Status", data.response, "info");
            listarLinks();
        }
    </script>
</body>
</html>